/**
 * Flickable: a Zepto plugin for making elements flickable on a touch device
 * 2012, Tom Longo
 *
 * Licensed under the Whatever License. Use it for whatever you want!
 * 
 * @author tom@kojo.com.au
 * @version 1.0
 * 
 * @requires 
 * Zepto JavaScript Library
 */
(function(a){function q(){var c="";for(var d=0;d<3;d++){c+=b.eventLog[d]+" | "}var e="<pre>";e=e+"last 3 events: "+c+"<br />";e=e+"start: {x:"+b.start.x+", y:"+b.start.y+",time: "+b.start.time+"}<br />";e=e+"delta: {<br />";e=e+"\tprevPos: {"+b.delta.prevPos.x+", "+b.delta.prevPos.y+"}<br />";e=e+"\tdist: {"+b.delta.dist.x+", "+b.delta.dist.y+"}<br />";e=e+"\tdir: {"+b.delta.dir.x+", "+b.delta.dir.y+"}<br />";e=e+"}<br />";e=e+"\tend: {<br />";e=e+"\tspeed: {"+b.end.speed.x+", "+b.end.speed.y+"}<br />";e=e+"\tflick: {"+b.end.flick.x+", "+b.end.flick.y+"}<br />";e=e+"\tduration: "+b.end.duration+"<br />";e=e+"}";e=e+"</pre>";a("#flickableDebugger").html(e)}function p(a){if(g){console.log(a);b.eventLog.splice(0,0,a);q()}}function o(){if(!a("#flickableDebugger").length){g=true;b=c;b.eventLog=[];var d='<div id="flickableDebugger" style="position: fixed; bottom: 0; margin: 0 auto; padding: 10px; width: 100%; background: #000; color: #fff; font-family: courier, sans-serif;">Debugger</div>';a("body").append(d)}}function n(a){var b=document.createElement("div"),c="Khtml Ms O Moz Webkit".split(" "),d=c.length;return function(a){if(a in b.style)return true;a=a.replace(/^[a-z]/,function(a){return a.toUpperCase()});while(d--){if(c[d]+a in b.style){return true}}return false}}function m(a,b){if(!parseInt(b)){var b,c=a.data("segments"),d=l(a,a.data("flickDirection"));d=="y"?b=a.height()/c:b=a.width()/c}return b}function l(a,b){if(b!=="x"&&b!=="y"){a.height()>a.width()?b="y":b="x"}return b}function k(a){var c=a.timeStamp-b.start.time,d=Math.abs(Math.round(b.delta.dist.x/c*100)/100),e=Math.abs(Math.round(b.delta.dist.y/c*100)/100),h=b.delta.dir.x,i=b.delta.dir.y,j=0,k=0;if(d>f){j=h}else if(e>f){k=i}b.end.duration=c;b.end.speed={x:d,y:e};b.end.flick={x:j,y:k};if(g){p("Touch end");q()}}function j(a){var c,d;typeof a.touches[0].pageX!="undefined"?c=a.touches[0].pageX:c=a.pageX;typeof a.touches[0].pageY!="undefined"?d=a.touches[0].pageY:d=a.pageY;var e,f,h=c,i=d,j=c-b.start.x,k=d-b.start.y;if(c>b.delta.prevPos.x){e=1}else if(c<b.delta.prevPos.x){e=-1}else{e=0}if(d>b.delta.prevPos.y){f=1}else if(d<b.delta.prevPos.y){f=-1}else{f=0}b.delta.prevPos={x:h,y:i};b.delta.dist={x:j,y:k};b.delta.dir={x:e,y:f};if(g){q()}}function i(a){var d,e;typeof a.touches[0].pageX!="undefined"?d=a.touches[0].pageX:d=a.pageX;typeof a.touches[0].pageY!="undefined"?e=a.touches[0].pageY:e=a.pageY;b=c;b.start={x:d,y:e,time:a.timeStamp};b.delta.prevPos={x:d,y:e};j(a);if(g){q()}}var b,c={start:{x:0,y:0,time:0},delta:{prevPos:{x:0,y:0},dist:{x:0,y:0},dir:{x:0,y:0}},end:{duration:0,speed:{x:0,y:0},flick:{x:0,y:0}}},d=false,e=0,f=.7,g=false;var h={init:function(b){var c=a.extend({enableDebugger:false,segments:5,flickThreshold:false,segmentPx:"auto",flickDirection:"auto",preventDefault:true,onCreate:false,onFlick:false,onFlickLeft:false,onFlickRight:false,onFlickUp:false,onFlickDown:false,onMove:false,onStart:false,onEnd:false},b);return this.each(function(){var b=a(this),e=b.data("isAlive");if(!e){var h=c.segments,p=l(b,c.flickDirection);b.data("isAlive",true).data("pos",0).data("segment",0).data("segments",h).data("flickDirection",p).data("segmentPx",m(b,c.segmentPx));a(b).bind({onStart:function(){a(this).flickable("start",c.onStart)},onMove:function(){a(this).flickable("move",c.onMove)},onEnd:function(){a(this).flickable("finished",c.onEnd)},onScroll:function(){a(this).flickable("scrollToSegment",c.onScroll)},onScrollPrev:function(){a(this).flickable("scrollPrev",c.onScrollPrev)},onScrollNext:function(){a(this).flickable("scrollNext",c.onScrollNext)},onFlick:function(){a(this).flickable("flick",c.onFlick)},onFlickLeft:function(){a(this).flickable("flickLeft",c.onFlickLeft)},onFlickRight:function(){a(this).flickable("flickRight",c.onFlickRight)},onFlickUp:function(){a(this).flickable("flickUp",c.onFlickUp)},onFlickDown:function(){a(this).flickable("flickDown",c.onFlickDown)},touchstart:function(b){i(b);a(this).trigger("onStart")},touchmove:function(b){if(c.preventDefault){b.preventDefault()}j(b);a(this).trigger("onMove")},touchend:function(b){k(b);a(this).trigger("onEnd")}});if(!n("transform")){d=true}if(parseInt(c.flickThreshold)){f=parseInt(c.flickThreshold)}if(g||c.enableDebugger){o()}b.flickable("create",c.onCreate)}})},create:function(d){var f=a(this);b=c;e++;p("It's alive!");if(!f.attr("id")){f.attr("id","flickable"+e)}f.flickable("scrollToSegment");if(typeof d=="function"){d.call(this,e)}},start:function(c){p("Touch start");var d=a(this),e=parseInt(d.data("segment")),f=parseInt(d.data("segmentPx")),g=-(f*e);d.data("anchor",g);if(typeof c=="function"){c.call(this,b)}},segment:function(b){var c=a(this),d=parseInt(c.data("segments")),e=parseInt(c.data("segment"));if(typeof b!="undefined"){if(b>=d){b=d-1}else if(b<0){b=0}c.data("segment",b)}c.trigger("onScroll");return parseInt(c.data("segment"))},move:function(c){var e=a(this),f,g,h=e.data("flickDirection"),i=parseInt(e.data("anchor")),f=i+b.delta.dist[h];if(d){if(h=="y"){e.css("top",f)}else{e.css("left",f)}}else{h=="y"?g="(0,"+f+"px,0)":g="("+f+"px,0,0)";document.getElementById(e.attr("id")).style.webkitTransform="translate3d"+g}a(this).data("pos",f);if(typeof c=="function"){c.call(this,b)}},scrollNext:function(c){p("Next segment");var d=a(this),e=parseInt(d.data("segment"))+1;d.flickable("segment",e);if(typeof c=="function"){c.call(this,b)}},scrollPrev:function(c){p("Previous segment");var d=a(this),e=parseInt(d.data("segment"))-1;d.flickable("segment",e);if(typeof c=="function"){c.call(this,b)}},flick:function(c){p("You flicked");var d=a(this);switch(b.end.flick.x){case-1:d.trigger("onFlickLeft");break;case 1:d.trigger("onFlickRight");break}switch(b.end.flick.y){case-1:d.trigger("onFlickUp");break;case 1:d.trigger("onFlickDown");break}if(typeof c=="function"){c.call(this,b)}},flickLeft:function(c){p("Flicked left");var d=a(this);d.trigger("onScrollNext");if(typeof c=="function"){c.call(this,b)}},flickRight:function(c){p("Flicked right");var d=a(this);d.trigger("onScrollPrev");if(typeof c=="function"){c.call(this,b)}},flickUp:function(c){p("Flicked up");var d=a(this);d.trigger("onScrollNext");if(typeof c=="function"){c.call(this,b)}},flickDown:function(c){p("Flicked down");var d=a(this);d.trigger("onScrollPrev");if(typeof c=="function"){c.call(this,b)}},scrollToSegment:function(c){var e=a(this),f,g=e.data("flickDirection"),h=parseInt(e.data("segments")),i=parseInt(e.data("segment")),j=parseInt(e.data("segmentPx")),k=-(j*i),l="ease-out";p("Sliding to segment "+i);if(b.end.flick.x||b.end.flick.y){l="cubic-bezier(0, .70, .35, 1)"}e.data("anchor",k).data("pos",k).data("segment",i);if(d){if(g=="y"){e.anim({top:k},.3,l)}else{e.anim({left:k},.3,l)}}else{g=="y"?f="0px, "+k+"px, 0px":f=k+"px, 0px, 0px";e.anim({translate3d:f},.3,l)}if(typeof c=="function"){c.call(this,b)}},finished:function(c){var d=a(this),e=d.data("flickDirection"),f=parseInt(d.data("segments")),g=parseInt(d.data("segment")),h=parseInt(d.data("segmentPx")),i=parseInt(d.data("anchor")),j=parseInt(d.data("pos"));var k;j<0?k=Math.abs(Math.round(j/h)):k=0;p("Nearest segment is "+k);if(typeof c=="function"){c.call(this,b)}if(g==k){if(b.end.flick[e]){return d.trigger("onFlick")}}d.flickable("segment",k)}};a.fn.flickable=function(b){if(h[b]){return h[b].apply(this,Array.prototype.slice.call(arguments,1))}else if(typeof b==="object"||!b){return h.init.apply(this,arguments)}else{a.error("Method "+b+" does not exist")}}})(Zepto)